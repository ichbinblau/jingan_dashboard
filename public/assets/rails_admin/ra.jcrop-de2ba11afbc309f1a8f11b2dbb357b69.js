(function(e){e.widget("ra.jcropForm",{_create:function(){var e=this,t=e.element;t.find("a.thumbnail").unbind().bind("click",function(n){return e._bindModalOpening(n,t.find("a.jcrop_handle").data("link")),!1})},_bindModalOpening:function(t,n){t.preventDefault(),widget=this;if(e("#modal").length)return!1;var r=this._getModal();setTimeout(function(){e.ajax({url:n,beforeSend:function(e){e.setRequestHeader("Accept","text/javascript")},success:function(e,t,n){r.find(".modal-body").html(e),widget._bindFormEvents()},error:function(e,t,n){r.find(".modal-body").html(e.responseText)},dataType:"text"})},100)},_bindFormEvents:function(){var t=this,n=this._getModal(),r=n.find("form"),i=n.find(":submit[name=_save]").html(),s=n.find(":submit[name=_continue]").html();n.find(".form-actions").remove();var o=e.extend({bgColor:"white",keySupport:!1,onSelect:t.updateCoordinates},rails_admin_jcrop_options);n.find("img.jcrop-subject").Jcrop(o),r.attr("data-remote",!0),n.find(".modal-header-title").text(r.data("title")),n.find(".cancel-action").unbind().click(function(){return n.modal("hide"),!1}).html(s),n.find(".save-action").unbind().click(function(){return r.submit(),!1}).html(i),e(document).trigger("rails_admin.dom_ready"),r.bind("ajax:complete",function(r,i,s){if(s=="error")n.find(".modal-body").html(i.responseText),t._bindFormEvents();else{var o=e.parseJSON(i.responseText),u=t.element.find("select").filter(":hidden");thumb=t.element.find("a.jcrop_handle").data("thumb"),t.element.find("a.thumbnail > img").removeAttr("src").attr("src",o.urls[thumb]+"?"+(new Date).valueOf()),t._trigger("success"),n.modal("hide")}})},updateCoordinates:function(t){var n=100/t.w,r=100/t.h,i=e("img.jcrop-subject").width(),s=e("img.jcrop-subject").height(),o=e("img.jcrop-subject").data("geometry").split(",")[0]/i;e("#preview").css({width:Math.round(n*i)+"px",height:Math.round(r*s)+"px",marginLeft:"-"+Math.round(n*t.x)+"px",marginTop:"-"+Math.round(r*t.y)+"px"}),e("#crop_x").val(Math.round(t.x*o)),e("#crop_y").val(Math.round(t.y*o)),e("#crop_w").val(Math.round(t.w*o)),e("#crop_h").val(Math.round(t.h*o))},_getModal:function(){var t=this;return t.dialog||(t.dialog=e('          <div id="modal" class="modal fade">            <div class="modal-header">              <a href="#" class="close" data-dismiss="modal">&times;</a>              <h3 class="modal-header-title">...</h3>            </div>            <div class="modal-body">              ...            </div>            <div class="modal-footer">              <a href="#" class="btn cancel-action">...</a>              <a href="#" class="btn btn-primary save-action">...</a>            </div>          </div>').modal({keyboard:!0,backdrop:!0,show:!0}).on("hidden",function(){t.dialog.remove(),t.dialog=null})),this.dialog}})})(jQuery),$(function(){$("div.jcrop_type").jcropForm()});